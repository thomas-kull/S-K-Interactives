<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Capacity Explorer — Efficiency, Utilization, and OEE (%)</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --ink: #e5e7eb; /* gray-200 */
      --muted: #94a3b8; /* slate-400 */
      --accent: #22d3ee; /* cyan-400 */
      --accent-2: #a78bfa; /* violet-400 */
      --ok: #34d399; /* green-400 */
      --bad: #f87171; /* red-400 */
      --warn: #f59e0b; /* amber-500 */
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; background: linear-gradient(180deg, #0b1223, var(--bg)); color: var(--ink); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 20px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.35); overflow: hidden; }
    header { padding: 18px 22px; border-bottom: 1px solid rgba(255,255,255,0.06); display:flex; gap:16px; align-items:center; justify-content: space-between; }
    header .title { font-weight: 700; letter-spacing: .2px; font-size: clamp(18px, 2vw, 24px); }
    header .subtitle { color: var(--muted); font-size: 13px; }
    .grid { display: grid; grid-template-columns: 360px 1fr; gap: 12px; }
    @media (max-width: 920px){ .grid{ grid-template-columns: 1fr; } }
    .panel { padding: 16px; }
    .controls { display: grid; gap: 14px; }
    .control { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px 12px 10px; }
    .row { display:flex; align-items:center; justify-content: space-between; gap: 10px; }
    .row label { font-weight: 600; }
    .row output { min-width: 90px; text-align: right; color: var(--accent); font-variant-numeric: tabular-nums; }
    input[type="range"] { width: 100%; accent-color: var(--accent-2); }
    .btns { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { cursor: pointer; background: linear-gradient(90deg, var(--accent), var(--accent-2)); color: #0b0f19; font-weight: 700; border: none; border-radius: 999px; padding: 10px 14px; box-shadow: 0 4px 16px rgba(34,211,238,.25); transition: transform .06s ease; }
    button.secondary { background: transparent; color: var(--ink); border: 1px solid rgba(255,255,255,0.16); box-shadow: none; }
    button:active { transform: translateY(1px) scale(.99); }
    #plot { height: 520px; }
    footer { padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.06); color: var(--muted); font-size: 12px; display:flex; align-items:center; justify-content: space-between; flex-wrap: wrap; gap:8px; }
    code.inline { background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 6px; }
    .banner { display:none; padding: 10px 12px; border-top: 1px solid rgba(255,255,255,0.06); background: rgba(245, 158, 11, 0.12); color: #fde68a; font-size: 13px; }
    .banner.error { background: rgba(248, 113, 113, 0.12); color: #fecaca; }
    .tests { margin-top: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; }
    .test-row { display:flex; align-items:center; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.06); }
    .test-row:last-child { border-bottom: none; }
    .badge { font-size: 12px; border-radius: 999px; padding: 2px 8px; font-weight: 700; letter-spacing: .3px; }
    .pass { background: rgba(52, 211, 153, .2); color: var(--ok); border: 1px solid rgba(52, 211, 153, .4); }
    .fail { background: rgba(248, 113, 113, .2); color: var(--bad); border: 1px solid rgba(248, 113, 113, .4); }
    details summary { cursor: pointer; color: var(--muted); }
    .kpis { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; margin-top: 10px; }
    .kpi { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
    .kpi .label { color: var(--muted); font-size: 12px; }
    .kpi .value { font-weight: 700; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <div class="title">Capacity Explorer — Efficiency, Utilization, and OEE (%)</div>
          <div class="subtitle">See % metrics morph as you adjust inputs. Y‑axis is fixed, so the bars change height—great for quick comparisons.</div>
        </div>
        <div class="btns">
          <button id="shareBtn" title="Copy a link with current slider values">Copy share link</button>
          <button id="fitBtn" class="secondary" title="Fit axes to current parameters">Fit axes</button>
          <button id="resetBtn" class="secondary" title="Reset sliders to defaults">Reset</button>
          <button id="testBtn" class="secondary" title="Run built‑in tests">Run self‑test</button>
        </div>
      </header>
      <div id="diag" class="banner" role="status" aria-live="polite"></div>

      <div class="grid">
        <!-- Controls -->
        <section class="panel">
          <div class="controls" id="controls">
            <!-- Core inputs -->
            <div class="control" data-key="r">
              <div class="row"><label for="r">Design capacity r (units/hour)</label><output id="r_val"></output></div>
              <input id="r" type="range" min="10" max="1000" value="200" step="5" />
            </div>
            <div class="control" data-key="A">
              <div class="row"><label for="A">Availability A (0–1)</label><output id="A_val"></output></div>
              <input id="A" type="range" min="0" max="1" value="0.90" step="0.01" />
            </div>
            <div class="control" data-key="P">
              <div class="row"><label for="P">Performance P (0–1)</label><output id="P_val"></output></div>
              <input id="P" type="range" min="0" max="1" value="0.95" step="0.01" />
            </div>
            <div class="control" data-key="Q">
              <div class="row"><label for="Q">Quality Q (0–1)</label><output id="Q_val"></output></div>
              <input id="Q" type="range" min="0" max="1" value="0.98" step="0.01" />
            </div>
            <div class="control" data-key="rActual">
              <div class="row"><label for="rActual">Actual output rate (units/hour)</label><output id="rActual_val"></output></div>
              <input id="rActual" type="range" min="0" max="1000" value="150" step="5" />
            </div>
            <div class="control" data-key="Hrs">
              <div class="row"><label for="Hrs">Shift length (hours)</label><output id="Hrs_val"></output></div>
              <input id="Hrs" type="range" min="1" max="24" value="8" step="1" />
            </div>

            <div class="kpis">
              <div class="kpi"><div class="label">OEE (A·P·Q)</div><div class="value" id="kpi_oee"></div></div>
              <div class="kpi"><div class="label">Effective capacity r_eff</div><div class="value" id="kpi_reff"></div></div>
              <div class="kpi"><div class="label">Utilization</div><div class="value" id="kpi_util"></div></div>
              <div class="kpi"><div class="label">Efficiency</div><div class="value" id="kpi_eff"></div></div>
            </div>
          </div>

          <details class="tests" open>
            <summary>Built‑in tests (auto‑run)</summary>
            <div id="tests"></div>
          </details>
        </section>

        <!-- Plot -->
        <section class="panel">
          <div id="plot"></div>
        </section>
      </div>

      <footer>
        <div>
          Definitions: <code class="inline">OEE = A·P·Q</code>, <code class="inline">r_eff = r·OEE</code>, <code class="inline">Utilization = r_actual / r</code>, <code class="inline">Efficiency = r_actual / r_eff</code>. Chart shows these **as percentages**.
        </div>
        <div>
          Prefer a waterfall (losses) view? I can add a second plot for Availability→Performance→Quality.
        </div>
      </footer>
    </div>
  </div>

  <noscript>
    <div style="max-width:1100px;margin:12px auto;color:#fecaca;background:rgba(248,113,113,.12);padding:12px;border:1px solid rgba(248,113,113,.4);border-radius:12px;">
      This page requires JavaScript to run.
    </div>
  </noscript>

  <script>
    // =============== Plotly Loader (robust) ===============
    function loadPlotly() {
      if (window.Plotly) return Promise.resolve(window.Plotly);
      const sources = [
        "https://cdn.plot.ly/plotly-2.35.2.min.js",
        "https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.35.2/plotly.min.js",
        "https://unpkg.com/plotly.js-dist-min@2.35.2/plotly.min.js",
        "https://cdn.plot.ly/plotly-latest.min.js",
        "https://unpkg.com/plotly.js-dist-min/plotly.min.js"
      ];
      const diag = document.getElementById('diag');
      function show(msg, asError=false){
        diag.style.display = 'block'; diag.className = 'banner' + (asError ? ' error' : ''); diag.textContent = msg;
      }
      return new Promise((resolve, reject) => {
        let idx = 0; const tried = [];
        const next = () => {
          if (window.Plotly) { show(`Plotly ready${tried.length ? ` (from ${tried[tried.length-1]})` : ''}.`); return resolve(window.Plotly); }
          if (idx >= sources.length) { show('Failed to load Plotly from all sources.', true); return reject(new Error('Plotly load failed')); }
          const url = sources[idx++]; tried.push(url); show(`Loading Plotly… (${url})`);
          const s = document.createElement('script'); s.src = url; s.async = true; let done = false;
          const cleanup = () => { s.onload = s.onerror = null; };
          const timer = setTimeout(() => { if (!done) { s.remove(); next(); } }, 8000);
          s.onload = () => { done = true; clearTimeout(timer); cleanup(); setTimeout(() => { window.Plotly ? resolve(window.Plotly) : next(); }, 0); };
          s.onerror = () => { done = true; clearTimeout(timer); cleanup(); next(); };
          document.head.appendChild(s);
        };
        next();
      });
    }

    // =============== State & Model ===============
    const params = new URLSearchParams(location.search);
    const keys = ["r","A","P","Q","rActual","Hrs"];

    function getDefaults(){
      return { r: 200, A: 0.90, P: 0.95, Q: 0.98, rActual: 150, Hrs: 8 };
    }

    function readState(){
      const p = getDefaults();
      keys.forEach(k => { if(params.has(k)) p[k] = Number(params.get(k)); });
      return p;
    }

    function serializeState(p){
      const q = new URLSearchParams();
      keys.forEach(k => q.set(k, String(p[k])));
      return q.toString();
    }

    function writeState(p){
      history.replaceState(null, "", `${location.pathname}?${serializeState(p)}`);
    }

    // Formulas
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }
    function oee(p){ return clamp01(p.A) * clamp01(p.P) * clamp01(p.Q); }
    function rEff(p){ return p.r * oee(p); }
    function utilization(p){ return p.r > 0 ? p.rActual / p.r : 0; }
    function efficiency(p){ const re = rEff(p); return re > 0 ? p.rActual / re : 0; }

    // Formatting
    function fmt(n,dec=2){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec, minimumFractionDigits:dec}); }

    // =============== Axes (fixed %) ===============
    const categories = ['Utilization','Efficiency','OEE'];
    let axes = { y:[0, 120] }; // fixed by default; Fit will expand if needed

    function fitAxesIfNeeded(vals){
      const maxV = Math.max(...vals);
      const target = Math.max(100, Math.min(200, Math.ceil(maxV/5)*5 + 5));
      axes.y = [0, target];
      if (!window.Plotly) return;
      const gd = document.getElementById('plot');
      window.Plotly.relayout(gd, { 'yaxis.range': axes.y, 'yaxis.autorange': false });
    }

    // =============== UI Init ===============
    const state = readState();
    const outputs = {};

    function syncSlidersFromState(){
      const mapFmt = { r: (v)=>fmt(v), A: (v)=>v.toFixed(2), P: (v)=>v.toFixed(2), Q: (v)=>v.toFixed(2), rActual: (v)=>fmt(v), Hrs: (v)=>fmt(v,0) };
      keys.forEach(k => {
        const el = document.getElementById(k);
        const out = document.getElementById(k + "_val");
        if(el && out){ el.value = state[k]; out.textContent = mapFmt[k](state[k]); outputs[k] = out; }
      });
      updateKPIs();
    }

    function attachHandlers(){
      ['r','A','P','Q','rActual'].forEach(k => {
        const el = document.getElementById(k);
        el.addEventListener('input', () => {
          state[k] = Number(el.value);
          const mapFmt = { r: (v)=>fmt(v), A: (v)=>v.toFixed(2), P: (v)=>v.toFixed(2), Q: (v)=>v.toFixed(2), rActual: (v)=>fmt(v) };
          outputs[k].textContent = mapFmt[k](state[k]);
          writeState(state);
          updateKPIs();
          updateBarsOnly();
        });
      });

      document.getElementById('Hrs').addEventListener('input', () => {
        state.Hrs = Number(document.getElementById('Hrs').value);
        outputs['Hrs'].textContent = fmt(state.Hrs,0);
        writeState(state);
        // Hrs does not affect % metrics; keep for parity and future features.
      });

      document.getElementById('fitBtn').addEventListener('click', () => fitAxesIfNeeded(getPercents()));

      document.getElementById('resetBtn').addEventListener('click', () => {
        const d = getDefaults(); keys.forEach(k => state[k] = d[k]);
        syncSlidersFromState(); writeState(state);
        axes.y = [0,120];
        draw(true);
      });

      document.getElementById('shareBtn').addEventListener('click', async () => {
        const url = location.href; try { await navigator.clipboard.writeText(url); flash("Link copied ✔"); } catch(e){ prompt("Copy this link:", url); }
      });

      document.getElementById('testBtn').addEventListener('click', runTests);
    }

    function updateKPIs(){
      const O = oee(state);
      const RE = rEff(state);
      const U = utilization(state);
      const E = efficiency(state);
      document.getElementById('kpi_oee').textContent = (O*100).toFixed(1) + ' %';
      document.getElementById('kpi_reff').textContent = fmt(RE,2) + ' u/hr';
      document.getElementById('kpi_util').textContent = (U*100).toFixed(1) + ' %';
      document.getElementById('kpi_eff').textContent = (E*100).toFixed(1) + ' %';
    }

    function flash(msg){ const b = document.getElementById("shareBtn"); const old = b.textContent; b.textContent = msg; setTimeout(() => b.textContent = old, 1200); }

    // =============== Plot rendering (bar chart of %) ===============
    function getPercents(){
      const U = Math.max(0, utilization(state))*100;
      const E = Math.max(0, efficiency(state))*100;
      const O = Math.max(0, oee(state))*100;
      return [U, E, O];
    }

    function traces(){
      const vals = getPercents();
      return [
        { type: 'bar', x: categories, y: vals, name: 'Percent', text: vals.map(v=>v.toFixed(1)+'%'), textposition: 'auto' }
      ];
    }

    function layout(){
      return {
        uirevision: 'freeze',
        paper_bgcolor: "rgba(0,0,0,0)", plot_bgcolor: "rgba(0,0,0,0)",
        margin: { l: 60, r: 20, t: 30, b: 60 },
        xaxis: { title: "Metric", type: 'category', gridcolor: "rgba(255,255,255,0.08)", zerolinecolor: "rgba(255,255,255,0.25)" },
        yaxis: { title: "Percent (%)", range: axes.y, autorange:false, gridcolor: "rgba(255,255,255,0.08)", zerolinecolor: "rgba(255,255,255,0.25)", ticksuffix: '%'},
        showlegend: false
      };
    }

    function draw(initial=false){
      if (!window.Plotly) return;
      const gd = document.getElementById('plot');
      const tr = traces();
      const lay = layout();
      const cfg = { displaylogo:false, responsive:true };
      if(!draw.hasPlotted){ window.Plotly.newPlot(gd, tr, lay, cfg); draw.hasPlotted = true; }
      else if (!initial){ window.Plotly.react(gd, tr, lay, cfg); }
    }

    function updateBarsOnly(){
      if (!window.Plotly) return;
      const gd = document.getElementById('plot');
      const vals = getPercents();
      window.Plotly.restyle(gd, { y: [vals], text: [vals.map(v=>v.toFixed(1)+'%')] }, [0]);
      // Keep default fixed range; show guidance if out of view
      const maxV = Math.max(...vals);
      const diag = document.getElementById('diag');
      if (maxV > axes.y[1]*0.98) { diag.style.display='block'; diag.className='banner'; diag.textContent='Tip: bars exceed the view — click “Fit axes”.'; }
      else if (maxV < axes.y[1]*0.15) { diag.style.display='block'; diag.className='banner'; diag.textContent='Tip: bars are small — click “Fit axes” to tighten.'; }
      else { diag.style.display='none'; }
    }

    // =============== Tests (auto‑run) ===============
    function approxEqual(a,b,eps=1e-6){ return Math.abs(a-b) <= eps; }

    function renderTestRow(name, passed, detail){
      const row = document.createElement('div'); row.className = 'test-row';
      const left = document.createElement('div'); left.textContent = name;
      const right = document.createElement('div'); right.className = 'badge ' + (passed?'pass':'fail'); right.textContent = passed? 'PASS' : 'FAIL';
      row.appendChild(left); row.appendChild(right);
      if (detail){ const d = document.createElement('div'); d.style.color = 'var(--muted)'; d.style.fontSize = '12px'; d.textContent = detail; d.style.flexBasis = '100%'; d.style.marginTop = '4px'; row.appendChild(d); }
      return row;
    }

    function runTests(){
      const container = document.getElementById('tests'); container.innerHTML = '';

      // Test 1: OEE equals A*P*Q within tolerance
      (function(){
        const p = {r:200,A:0.9,P:0.95,Q:0.98,rActual:150,Hrs:8};
        const expected = p.A*p.P*p.Q; const o = clamp01(p.A)*clamp01(p.P)*clamp01(p.Q);
        container.appendChild(renderTestRow('OEE = A·P·Q', approxEqual(o, expected, 1e-12), `oee=${o.toFixed(6)} expected=${expected.toFixed(6)}`));
      })();

      // Test 2: Utilization and Efficiency definitions
      (function(){
        const p = {r:250,A:0.9,P:0.9,Q:1.0,rActual:200,Hrs:8};
        const u = (p.r>0? p.rActual/p.r : 0); const e = (p.r*p.A*p.P*p.Q>0? p.rActual/(p.r*p.A*p.P*p.Q) : 0);
        const okU = approxEqual(u, utilization(p), 1e-12);
        const okE = approxEqual(e, (p.rActual/(p.r*p.A*p.P*p.Q)), 1e-12);
        container.appendChild(renderTestRow('Utilization & Efficiency formulas', okU && okE, `U=${u.toFixed(6)} E=${e.toFixed(6)}`));
      })();

      // Test 3: Bars reflect percentages (ordering Utilization, Efficiency, OEE)
      (function(){
        const vals = getPercents();
        const pass = vals.length === 3 && vals.every(v => v>=0);
        container.appendChild(renderTestRow('Bar values exist for U, E, OEE', pass, `vals=[${vals.map(v=>v.toFixed(1)).join(', ')}]`));
      })();

      // Test 4: Axis default is 0–120
      (function(){
        const pass = (axes.y[0]===0 && axes.y[1]===120);
        container.appendChild(renderTestRow('Default y-axis range 0–120%', pass, `range=[${axes.y.join(', ')}]`));
      })();

      // Test 5: Plotly availability
      (function(){ const pass = !!window.Plotly; container.appendChild(renderTestRow('Plotly is available', pass, pass? 'OK' : 'Not loaded — check banner above.')); })();
    }

    // =============== Kickoff ===============
    window.addEventListener("DOMContentLoaded", () => {
      syncSlidersFromState(); attachHandlers(); writeState(state);
      loadPlotly().then(() => { draw(true); runTests(); }).catch(() => { runTests(); });
    });
  </script>
</body>
</html>
